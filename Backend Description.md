# Crew - Slack-lite 서비스

Crew는 Slack과 유사한 기능을 제공하는 협업 메신저 서비스입니다. 사용자 관리, 채널 관리, 메시지 기능을 제공합니다.

## 기술 스택

- **Framework**: NestJS
- **Database**: SQLite (TypeORM)
- **Authentication**: JWT (JSON Web Tokens)
- **Language**: TypeScript
- **Testing**: Jest

## 프로젝트 구조

```
src/
├── modules/
│   ├── auth/          # 인증 모듈 (회원가입, 로그인)
│   ├── users/         # 사용자 관리 모듈
│   ├── channels/      # 채널 관리 모듈
│   └── messages/      # 메시지 관리 모듈
├── app.module.ts      # 루트 모듈
└── main.ts            # 애플리케이션 진입점
```

## API 엔드포인트 및 동작 절차

### 1. 인증 (Auth)

#### 1.1 회원가입
- **엔드포인트**: `POST /auth/signup`
- **인증 필요**: 없음
- **역할**: 새로운 사용자 계정을 생성합니다.
- **동작 절차**:
  1. 요청 본문에서 이메일, 비밀번호, 사용자명, 표시명(선택)을 받습니다.
  2. 사용자명 중복 여부를 확인합니다.
  3. 비밀번호를 bcrypt로 해시화합니다.
  4. 새 사용자를 데이터베이스에 저장합니다.
  5. 비밀번호를 제외한 사용자 정보를 반환합니다.

#### 1.2 로그인
- **엔드포인트**: `POST /auth/login`
- **인증 필요**: 없음
- **역할**: 사용자 인증을 수행하고 JWT Access Token을 발급합니다.
- **동작 절차**:
  1. 요청 본문에서 이메일 또는 사용자명과 비밀번호를 받습니다.
  2. 이메일 또는 사용자명으로 사용자를 조회합니다.
  3. 사용자 계정 활성화 여부를 확인합니다.
  4. 비밀번호를 검증합니다.
  5. JWT Access Token을 생성합니다.
  6. 사용자 정보와 Access Token을 반환합니다.

---

### 2. 사용자 관리 (Users)

#### 2.1 모든 사용자 조회
- **엔드포인트**: `GET /users`
- **인증 필요**: 없음
- **역할**: 시스템에 등록된 모든 사용자 목록을 조회합니다.
- **동작 절차**:
  1. 데이터베이스에서 모든 사용자를 조회합니다.
  2. 비밀번호를 제외한 사용자 정보를 반환합니다.

#### 2.2 특정 사용자 조회
- **엔드포인트**: `GET /users/:id`
- **인증 필요**: 없음
- **역할**: 특정 사용자의 정보를 조회합니다.
- **동작 절차**:
  1. URL 파라미터에서 사용자 ID를 받습니다.
  2. 해당 ID의 사용자를 조회합니다.
  3. 사용자가 존재하지 않으면 404 에러를 반환합니다.
  4. 비밀번호를 제외한 사용자 정보를 반환합니다.

#### 2.3 사용자 생성
- **엔드포인트**: `POST /users`
- **인증 필요**: 없음
- **역할**: 새로운 사용자를 생성합니다. (일반적으로는 `/auth/signup` 사용 권장)
- **동작 절차**:
  1. 요청 본문에서 사용자 정보를 받습니다.
  2. 이메일 중복 여부를 확인합니다.
  3. 비밀번호를 해시화합니다.
  4. 새 사용자를 저장하고 반환합니다.

#### 2.4 사용자 프로필 업데이트
- **엔드포인트**: `PATCH /users/:id`
- **인증 필요**: 없음
- **역할**: 사용자의 프로필 정보를 업데이트합니다.
- **동작 절차**:
  1. URL 파라미터에서 사용자 ID를 받습니다.
  2. 요청 본문에서 업데이트할 정보를 받습니다.
  3. 사용자를 조회하고 정보를 업데이트합니다.
  4. 업데이트된 사용자 정보를 반환합니다.

#### 2.5 비밀번호 변경
- **엔드포인트**: `PATCH /users/:id/password`
- **인증 필요**: 없음
- **역할**: 사용자의 비밀번호를 변경합니다.
- **동작 절차**:
  1. URL 파라미터에서 사용자 ID를 받습니다.
  2. 요청 본문에서 새 비밀번호를 받습니다.
  3. 새 비밀번호를 해시화합니다.
  4. 사용자의 비밀번호를 업데이트합니다.
  5. 204 No Content를 반환합니다.

#### 2.6 사용자 활성화
- **엔드포인트**: `PATCH /users/:id/activate`
- **인증 필요**: 없음
- **역할**: 사용자 계정을 활성화합니다.
- **동작 절차**:
  1. URL 파라미터에서 사용자 ID를 받습니다.
  2. 사용자의 `isActive` 필드를 `true`로 설정합니다.
  3. 업데이트된 사용자 정보를 반환합니다.

#### 2.7 사용자 비활성화
- **엔드포인트**: `PATCH /users/:id/deactivate`
- **인증 필요**: 없음
- **역할**: 사용자 계정을 비활성화합니다.
- **동작 절차**:
  1. URL 파라미터에서 사용자 ID를 받습니다.
  2. 사용자의 `isActive` 필드를 `false`로 설정합니다.
  3. 업데이트된 사용자 정보를 반환합니다.

#### 2.8 사용자 삭제
- **엔드포인트**: `DELETE /users/:id`
- **인증 필요**: 없음
- **역할**: 사용자 계정을 삭제합니다.
- **동작 절차**:
  1. URL 파라미터에서 사용자 ID를 받습니다.
  2. 해당 사용자를 데이터베이스에서 삭제합니다.
  3. 204 No Content를 반환합니다.

---

### 3. 채널 관리 (Channels)

#### 3.1 채널 생성
- **엔드포인트**: `POST /channels`
- **인증 필요**: 있음 (JWT Token)
- **역할**: 새로운 채널을 생성하고 생성자를 자동으로 멤버로 추가합니다.
- **동작 절차**:
  1. JWT Token에서 사용자 ID를 추출합니다.
  2. 요청 본문에서 채널 정보(이름, 설명, 공개 여부)를 받습니다.
  3. 채널명 중복 여부를 확인합니다.
  4. 새 채널을 생성하고 `createdBy`에 사용자 ID를 저장합니다.
  5. 생성자를 채널의 `members`에 자동으로 추가합니다.
  6. 생성된 채널 정보를 반환합니다.

#### 3.2 모든 채널 조회
- **엔드포인트**: `GET /channels`
- **인증 필요**: 없음
- **역할**: 시스템에 등록된 모든 채널 목록을 조회합니다.
- **동작 절차**:
  1. 데이터베이스에서 모든 채널을 조회합니다.
  2. 생성일 기준 내림차순으로 정렬하여 반환합니다.

#### 3.3 내가 참여한 채널 목록 조회
- **엔드포인트**: `GET /channels/my-channels`
- **인증 필요**: 있음 (JWT Token)
- **역할**: 현재 로그인한 사용자가 참여한 채널 목록을 조회합니다.
- **동작 절차**:
  1. JWT Token에서 사용자 ID를 추출합니다.
  2. 해당 사용자가 멤버로 참여한 모든 채널을 조회합니다.
  3. 채널 목록을 반환합니다.

#### 3.4 특정 채널 조회
- **엔드포인트**: `GET /channels/:id`
- **인증 필요**: 없음
- **역할**: 특정 채널의 정보를 조회합니다.
- **동작 절차**:
  1. URL 파라미터에서 채널 ID를 받습니다.
  2. 해당 ID의 채널을 조회합니다.
  3. 채널이 존재하지 않으면 404 에러를 반환합니다.
  4. 채널 정보를 반환합니다.

#### 3.5 채널의 참가자 목록 조회
- **엔드포인트**: `GET /channels/:id/members`
- **인증 필요**: 없음
- **역할**: 특정 채널에 참가한 멤버 목록을 조회합니다.
- **동작 절차**:
  1. URL 파라미터에서 채널 ID를 받습니다.
  2. 채널을 조회하고 `members` 관계를 로드합니다.
  3. 채널이 존재하지 않으면 404 에러를 반환합니다.
  4. 멤버 목록을 반환합니다 (비밀번호 제외).

#### 3.6 채널 업데이트
- **엔드포인트**: `PATCH /channels/:id`
- **인증 필요**: 있음 (JWT Token)
- **역할**: 채널 정보를 업데이트합니다. (채널 생성자만 가능)
- **동작 절차**:
  1. JWT Token에서 사용자 ID를 추출합니다.
  2. URL 파라미터에서 채널 ID를 받습니다.
  3. 채널을 조회합니다.
  4. 채널의 `createdBy`와 사용자 ID가 일치하는지 확인합니다.
  5. 일치하지 않으면 403 Forbidden 에러를 반환합니다.
  6. 요청 본문에서 업데이트할 정보를 받습니다.
  7. 채널명 변경 시 중복 여부를 확인합니다.
  8. 채널 정보를 업데이트하고 반환합니다.

#### 3.7 채널 삭제
- **엔드포인트**: `DELETE /channels/:id`
- **인증 필요**: 있음 (JWT Token)
- **역할**: 채널을 삭제합니다. (채널 생성자만 가능)
- **동작 절차**:
  1. JWT Token에서 사용자 ID를 추출합니다.
  2. URL 파라미터에서 채널 ID를 받습니다.
  3. 채널을 조회합니다.
  4. 채널의 `createdBy`와 사용자 ID가 일치하는지 확인합니다.
  5. 일치하지 않으면 403 Forbidden 에러를 반환합니다.
  6. 채널을 데이터베이스에서 삭제합니다.
  7. 204 No Content를 반환합니다.

#### 3.8 채널 참여
- **엔드포인트**: `POST /channels/:id/join`
- **인증 필요**: 있음 (JWT Token)
- **역할**: 사용자를 채널의 멤버로 추가합니다.
- **동작 절차**:
  1. JWT Token에서 사용자 ID를 추출합니다.
  2. URL 파라미터에서 채널 ID를 받습니다.
  3. 채널과 사용자를 조회합니다.
  4. 이미 멤버인지 확인합니다.
  5. 채널의 `members`에 사용자를 추가합니다.
  6. 사용자의 `channels`에 채널을 추가합니다.
  7. 업데이트된 채널 정보를 반환합니다.

#### 3.9 채널 탈퇴
- **엔드포인트**: `POST /channels/:id/leave`
- **인증 필요**: 있음 (JWT Token)
- **역할**: 사용자를 채널의 멤버에서 제거합니다.
- **동작 절차**:
  1. JWT Token에서 사용자 ID를 추출합니다.
  2. URL 파라미터에서 채널 ID를 받습니다.
  3. 채널과 사용자를 조회합니다.
  4. 멤버인지 확인합니다.
  5. 채널의 `members`에서 사용자를 제거합니다.
  6. 사용자의 `channels`에서 채널을 제거합니다.
  7. 204 No Content를 반환합니다.

---

### 4. 메시지 관리 (Messages)

#### 4.1 메시지 생성
- **엔드포인트**: `POST /messages`
- **인증 필요**: 있음 (JWT Token)
- **역할**: 채널에 새로운 메시지를 생성합니다. (채널 멤버만 가능)
- **동작 절차**:
  1. JWT Token에서 사용자 ID를 추출합니다.
  2. 요청 본문에서 메시지 내용과 채널 ID를 받습니다.
  3. 채널을 조회하고 `members` 관계를 로드합니다.
  4. 채널이 존재하지 않으면 404 에러를 반환합니다.
  5. 사용자가 채널 멤버인지 확인합니다.
  6. 멤버가 아니면 403 Forbidden 에러를 반환합니다.
  7. 사용자 존재 여부를 확인합니다.
  8. 새 메시지를 생성하고 저장합니다.
  9. 생성된 메시지 정보를 반환합니다.

#### 4.2 모든 메시지 조회
- **엔드포인트**: `GET /messages`
- **인증 필요**: 없음
- **역할**: 시스템의 모든 메시지를 조회합니다.
- **동작 절차**:
  1. 데이터베이스에서 모든 메시지를 조회합니다.
  2. `author`와 `channel` 관계를 로드합니다.
  3. 생성일 기준 내림차순으로 정렬하여 반환합니다.

#### 4.3 특정 채널의 메시지 조회
- **엔드포인트**: `GET /messages/channel/:channelId`
- **인증 필요**: 있음 (JWT Token)
- **역할**: 특정 채널의 모든 메시지를 조회합니다. (채널 멤버만 가능)
- **동작 절차**:
  1. JWT Token에서 사용자 ID를 추출합니다.
  2. URL 파라미터에서 채널 ID를 받습니다.
  3. 채널을 조회하고 `members` 관계를 로드합니다.
  4. 채널이 존재하지 않으면 404 에러를 반환합니다.
  5. 사용자가 채널 멤버인지 확인합니다.
  6. 멤버가 아니면 403 Forbidden 에러를 반환합니다.
  7. 해당 채널의 모든 메시지를 조회합니다.
  8. `author`와 `channel` 관계를 로드합니다.
  9. 생성일 기준 오름차순으로 정렬하여 반환합니다.

#### 4.4 메시지 삭제
- **엔드포인트**: `DELETE /messages/:id`
- **인증 필요**: 있음 (JWT Token)
- **역할**: 메시지를 삭제합니다. (작성자이면서 채널 멤버만 가능)
- **동작 절차**:
  1. JWT Token에서 사용자 ID를 추출합니다.
  2. URL 파라미터에서 메시지 ID를 받습니다.
  3. 메시지를 조회하고 `channel` 관계를 로드합니다.
  4. 메시지가 존재하지 않으면 404 에러를 반환합니다.
  5. 메시지의 `authorId`와 사용자 ID가 일치하는지 확인합니다.
  6. 일치하지 않으면 403 Forbidden 에러를 반환합니다.
  7. 메시지의 채널을 조회하고 `members` 관계를 로드합니다.
  8. 사용자가 채널 멤버인지 확인합니다.
  9. 멤버가 아니면 403 Forbidden 에러를 반환합니다.
  10. 메시지를 데이터베이스에서 삭제합니다.
  11. 204 No Content를 반환합니다.

---

## 인증 및 권한

### JWT 인증
- 대부분의 채널 및 메시지 관련 작업은 JWT Token이 필요합니다.
- 로그인 시 받은 `accessToken`을 `Authorization` 헤더에 `Bearer {accessToken}` 형식으로 포함해야 합니다.

### 권한 체크
- **채널 업데이트/삭제**: 채널 생성자만 가능
- **메시지 생성/조회/삭제**: 해당 채널의 멤버만 가능
- **메시지 삭제**: 메시지 작성자이면서 채널 멤버여야 함

---

## 데이터베이스 관계

- **User ↔ Channel**: Many-to-Many 관계 (사용자는 여러 채널에 참여 가능, 채널은 여러 멤버 보유)
- **User ↔ Message**: One-to-Many 관계 (사용자는 여러 메시지 작성 가능)
- **Channel ↔ Message**: One-to-Many 관계 (채널은 여러 메시지 보유)

---

## 실행 방법

### 개발 서버 실행
```bash
npm run dev
```

### 테스트 실행
```bash
npm test
```

### 빌드
```bash
npm run build
```

---

## API 테스트

Postman Collection 파일(`postman_collection.json`)을 사용하여 API를 테스트할 수 있습니다.

1. Postman에서 Collection을 Import합니다.
2. 로그인 API를 먼저 호출하여 `accessToken`을 받습니다.
3. 인증이 필요한 API 호출 시 `Authorization` 헤더에 `Bearer {accessToken}`을 포함합니다.
